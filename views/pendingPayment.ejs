<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Pending â€” Supermarket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f3f6f1; font-family: "Segoe UI", sans-serif; }
    .spinner-wrap { margin-top: 8vh; text-align:center; }
    .info-card { max-width:700px; margin:24px auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
  </style>
</head>
<body>
  <nav class="navbar navbar-light shadow-sm px-4">
    <a class="navbar-brand" href="/">ðŸ›’ Supermarket</a>
  </nav>

  <div class="container">
    <div class="info-card">
      <h4 class="mb-3">Payment in progress</h4>
      <p class="text-muted">We've received your payment. We're waiting for the payment provider to confirm and finalise your order.</p>

      <div class="spinner-wrap">
        <div class="spinner-border text-success" role="status" style="width:4rem;height:4rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3" id="statusMsg">Checking payment statusâ€¦</p>
      </div>

      <div class="text-center mt-3">
        <a href="/" id="homeBtn" class="btn btn-outline-secondary" style="display:none;">Go to Home</a>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      const captureId = urlParams.get('captureId');
      if (!captureId) {
        document.getElementById('statusMsg').innerText = 'Missing payment identifier.';
        document.getElementById('homeBtn').style.display = 'inline-block';
        return;
      }

      // Prefer server-sent events: subscribe to /sse/paypal/:captureId
      if (window.EventSource) {
        try {
          const es = new EventSource(`/sse/paypal/${encodeURIComponent(captureId)}`);
          es.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data);
              if (data.finalized) {
                if (data.orderId) {
                  window.location.href = `/invoice/${encodeURIComponent(data.orderId)}`;
                } else {
                  window.location.href = '/';
                }
              }
            } catch (err) {
              // ignore parse errors
            }
          };
          es.onerror = () => {
            // fallback to polling if SSE fails
            es.close();
            startPolling();
          };
        } catch (err) {
          startPolling();
        }
      } else {
        startPolling();
      }

      // polling fallback
      let polls = 0;
      const maxPolls = 120; // longer fallback timeout (6 minutes)
      const intervalMs = 3000;
      async function startPolling() {
        try {
          const res = await fetch('/api/payment-status?captureId=' + encodeURIComponent(captureId));
          const data = await res.json();
          if (data.finalized) {
            if (data.orderId) {
              window.location.href = `/invoice/${encodeURIComponent(data.orderId)}`;
            } else {
              window.location.href = '/';
            }
            return;
          }
          polls++;
          if (polls >= maxPolls) {
            document.getElementById('statusMsg').innerText = 'Still processing â€” please check your orders later.';
            document.getElementById('homeBtn').style.display = 'inline-block';
            return;
          }
          setTimeout(startPolling, intervalMs);
        } catch (err) {
          document.getElementById('statusMsg').innerText = 'Error checking payment status.';
          document.getElementById('homeBtn').style.display = 'inline-block';
        }
      }
    })();
  </script>
</body>
</html>
